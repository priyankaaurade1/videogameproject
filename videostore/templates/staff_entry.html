{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Store Data Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #e3f2fd;
      padding: 10px;
      font-family: "Segoe UI", sans-serif;
    }
    .container-box {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .form-wrapper {
      flex: 0 0 60%;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .preview-wrapper {
      flex: 0 0 38%;
      background: #fff8e1;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      min-height: 400px;
    }
    .readonly-field[readonly] {
      background-color: #f8f9fa; 
      color: #6c757d;           
      font-weight: 500;
      cursor: not-allowed;
    }

    @media (max-width: 992px) {
      .form-wrapper, .preview-wrapper {
        flex: 100%;
      }
    }
  </style>
</head>
<body>
<div id="statusMessage" style="display:none; font-weight:bold;"></div>

<div class="container container-box">
  <!-- Left Form -->
  <div class="form-wrapper">
    <h3 class="text-center mb-3">üéÆ Game Store - Customer Entry</h3>
    <div class="text-center mb-4">
      <strong>üßæ Bill No:</strong> {{ bill_no }}
    </div>

    <form method="POST" id="entryForm" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Staff ID</label>
          <input type="text" class="form-control readonly-field" value="{{ request.user.username }}" readonly>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Customer ID</label>
          <input type="text" class="form-control readonly-field" name="customer_id" value="{{ customer_id }}" readonly>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Date</label>
          <input type="text" class="form-control readonly-field" value="{{ now|date:'Y-m-d' }}" readonly>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Time</label>
          <input type="text" class="form-control readonly-field" value="{{ now|time:'H:i:s' }}" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Customer Name</label>
        <input type="text" class="form-control" name="customer_name" required>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Machine Name</label>
          <input type="text" class="form-control" name="machine_name" required>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Machine Number</label>
          <input type="number" class="form-control" name="machine_number" required>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">In Points</label>
          <input type="number" class="form-control" name="in_points" min="0" required>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Out Points</label>
          <input type="number" class="form-control" name="out_points" min="0" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Expense Type</label>
          <select class="form-select" name="expense_type" id="expense_type" required>
            <option value="">-- Select Expense Type --</option>
            <option value="salary">Salary</option>
            <option value="tea">Tea</option>
            <option value="water">Water</option>
            <option value="lightbill">Light Bill</option>
            <option value="police">Police</option>
            <option value="goodluck">Good Luck</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">Amount</label>
          <input type="number" class="form-control" name="amount" id="amount" min="0" required>
        </div>
      </div>

      <div class="mb-3" id="remarks_group" style="display: none;">
        <label class="form-label">Remarks</label>
        <textarea class="form-control" name="remarks" id="remarks" rows="3"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Take Photo (Camera)</label>
        <div>
          <video id="camera" width="100%" autoplay playsinline style="border: 1px solid #ccc; border-radius: 5px;"></video>
          <canvas id="snapshot" style="display: none;"></canvas>
          <input type="hidden" name="photo_data" id="photo_data">
          <button type="button" class="btn btn-outline-primary mt-2" onclick="takeSnapshot()">üì∏ Take Snapshot</button>
        </div>
      </div>
      <div class="text-center">
      <button type="submit" class="btn btn-primary px-4">üíæ Save Data</button>
    </div>
    </form>
  </div>

  <!-- Right Panel -->
  <div class="preview-wrapper" id="printable_area">
    <h5 class="text-center mb-3">üìä Live Preview</h5>
    <div class="mb-2"><strong>Staff ID:</strong> <span id="prev_staff_id">{{ request.user.username }}</span></div>
    <div class="mb-2"><strong>Customer ID:</strong> <span id="prev_customer_id">{{ customer_id }}</span></div>
    <div class="mb-2"><strong>Date:</strong> <span id="prev_date">{{ now|date:"Y-m-d" }}</span></div>
    <div class="mb-2"><strong>Time:</strong> <span id="prev_time">{{ now|time:"H:i:s" }}</span></div>
    <div class="mb-2"><strong>Customer Name:</strong> <span id="prev_cust_name">-</span></div>
    <div class="mb-2"><strong>Machine Name:</strong> <span id="prev_machine_name">-</span></div>
    <div class="mb-2"><strong>Machine Number:</strong> <span id="prev_machine_number">-</span></div>
    <div class="mb-2"><strong>In Points:</strong> <span id="prev_in_points">-</span></div>
    <div class="mb-2"><strong>Out Points:</strong> <span id="prev_out_points">-</span></div>
    <div class="mb-2"><strong>Expense Type:</strong> <span id="prev_expense_type">-</span></div>
    <div class="mb-2"><strong>Amount:</strong> <span id="prev_good_luck">-</span></div>
    <div class="mb-2"><strong>Remarks:</strong> <span id="prev_remarks">-</span></div>

    <!-- Live photo preview -->
    <div class="mb-2"><strong>Captured Photo:</strong></div>
    <img id="preview_img" src="" style="max-width: 100%; border: 1px solid #ccc; border-radius: 5px;" alt="No photo yet">
    
    <div class="text-center mt-3">
      <button id="printBtn" class="btn btn-secondary px-4" style="display: none;">üñ®Ô∏è Print Data</button>
    </div>
  </div>
</div>

<script>
  // Camera access and snapshot logic
  const video = document.getElementById('camera');
  const canvas = document.getElementById('snapshot');
  const photoInput = document.getElementById('photo_data');
  const previewImg = document.getElementById('preview_img');

  if (navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function (stream) {
        video.srcObject = stream;
      })
      .catch(function (error) {
        alert("Camera not accessible.");
      });
  }

  function takeSnapshot() {
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    const dataURL = canvas.toDataURL('image/png');
    photoInput.value = dataURL;

    if (previewImg) {
      previewImg.src = dataURL;
    }

    alert("Photo captured!");
  }

  // Generic function to update text preview in real-time
  const updatePreview = (selector, target) => {
    const input = document.querySelector(selector);
    const preview = document.querySelector(target);
    if (input && preview) {
      input.addEventListener('input', function () {
        preview.innerText = this.value.trim() || '-';
      });
    }
  };

  // Attach listeners to all fields
  updatePreview('[name="customer_name"]', '#prev_cust_name');
  updatePreview('[name="machine_name"]', '#prev_machine_name');
  updatePreview('[name="machine_number"]', '#prev_machine_number');
  updatePreview('[name="in_points"]', '#prev_in_points');
  updatePreview('[name="out_points"]', '#prev_out_points');
  updatePreview('[name="amount"]', '#prev_good_luck'); // Reused for amount
  updatePreview('[name="remarks"]', '#prev_remarks');

  // Handle dropdown change for expense type and remarks visibility
  const expenseSelect = document.querySelector('[name="expense_type"]');
  const expensePreview = document.getElementById('prev_expense_type');
  const remarksGroup = document.getElementById('remarks_group');

  if (expenseSelect) {
    expenseSelect.addEventListener('change', function () {
      const selected = this.value || '-';
      if (expensePreview) expensePreview.innerText = selected;

      // Show remarks only if "Other" is selected
      remarksGroup.style.display = selected === 'other' ? 'block' : 'none';
    });
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('entryForm');
  const printBtn = document.getElementById('printBtn');
  const msgBox = document.getElementById('statusMessage');

  if (!form) return;

  form.addEventListener('submit', async function (e) {
    e.preventDefault(); // prevent form reload

    if (!confirm("Are you sure you want to save this data?")) return;

    const formData = new FormData(form);

    try {
      const response = await fetch('', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        // ‚úÖ Show message
        msgBox.innerText = "‚úÖ Data saved successfully!";
        msgBox.style.color = "green";
        msgBox.style.display = "block";

        // ‚úÖ Show print button
        printBtn.style.display = 'inline-block';

        // ‚úÖ Hide message after 5s
        setTimeout(() => {
          msgBox.style.display = 'none';
        }, 5000);
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Failed to save data.");
    }
  });

  if (printBtn) {
    printBtn.addEventListener('click', function () {
      const printContents = document.getElementById('printable_area').innerHTML;
      const originalContents = document.body.innerHTML;

      document.body.innerHTML = `
        <html><head><title>Print Preview</title>
          <style>
            body { font-family: Arial; margin: 20px; }
            .mb-2 { margin-bottom: 10px; }
          </style>
        </head><body>${printContents}</body></html>
      `;
      window.print();
      document.body.innerHTML = originalContents;
      window.location.reload(); // Optional if you want to clear data after print
    });
  }
});
</script>
</body>
</html>
